<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Req. Funcionales - Dashboard</title>
    <link rel="icon" href="../imgs/LOGO_MUNICIPALIDAD.png" type="image/png">
    <link rel="stylesheet" href="admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <header class="adr-header">
        <div class="adr-header-content">
            <div class="adr-logo-section">
                <img src="../imgs/LOGO_MUNICIPALIDAD.png" alt="Logo Municipalidad" class="adr-logo">
                <div class="adr-title-group">
                    <h1 class="adr-main-title">Req. Funcionales</h1>
                    <p class="adr-subtitle"></p>
                </div>
            </div>
            <nav class="adr-nav">
                <a href="admin.html" class="adr-nav-link adr-active">DASHBOARD</a>
                <a href="/request/requerimientos.html" class="adr-nav-link">REQUERIMIENTOS</a>
                <a href="#flujograma" class="adr-nav-link">FLUJOGRAMA</a>
                <a href="/log/login.html" class="adr-nav-link adr-nav-salir">SALIR</a>
            </nav>
        </div>
    </header>
    <main class="adr-main-container">
        <div class="adr-content-wrapper">
            <section class="adr-summary-section">
                <div class="adr-summary-card adr-total-card">
                    <i class="fas fa-clipboard-list adr-card-icon"></i>
                    <h2 class="adr-summary-title">TOTAL DE REQUERIMIENTOS</h2>
                    <div class="adr-summary-number">0</div>
                </div>

                <div class="adr-summary-card adr-status-card">
                    <div class="adr-status-item adr-pending">
                        <i class="fas fa-clock"></i>
                        <span class="adr-status-label">REQUERIMIENTOS PENDIENTES</span>
                        <span class="adr-status-value">0</span>
                    </div>
                    <div class="adr-status-item adr-process">
                        <i class="fas fa-spinner"></i>
                        <span class="adr-status-label">REQUERIMIENTOS EN PROCESO</span>
                        <span class="adr-status-value">0</span>
                    </div>
                    <div class="adr-status-item adr-completed">
                        <i class="fas fa-check-circle"></i>
                        <span class="adr-status-label">REQUERIMIENTOS FINALIZADOS</span>
                        <span class="adr-status-value">0</span>
                    </div>
                </div>
            </section>
            <section class="adr-chart-section">
                <div class="adr-chart-card">
                    <h3 class="adr-chart-title">
                        <i class="fas fa-chart-bar"></i>
                        Requerimientos por √Årea
                    </h3>
                    <div class="adr-bar-chart">
                        <div class="adr-bar-item">
                            <div class="adr-bar-wrapper">
                                <div class="adr-bar adr-bar-1" style="height: 80%;" data-value="8"></div>   
                            </div>
                            <span class="adr-bar-label">Subgerencia de Catastro, Planeamiento y Control Urbano</span>
                        </div>
                        <div class="adr-bar-item">
                            <div class="adr-bar-wrapper">
                                <div class="adr-bar adr-bar-2" style="height: 60%;" data-value="6"></div>
                            </div>
                            <span class="adr-bar-label">Subgerencia de Maquinaria52</span>
                        </div>
                        <div class="adr-bar-item">
                            <div class="adr-bar-wrapper">
                                <div class="adr-bar adr-bar-3" style="height: 40%;" data-value="4"></div>
                            </div>
                            <span class="adr-bar-label">Subgerencia de Supervisi√≥n y Ejecuci√≥n de Obras</span>
                        </div>
                        <div class="adr-bar-item">
                            <div class="adr-bar-wrapper">
                                <div class="adr-bar adr-bar-4" style="height: 75%;" data-value="7"></div>
                            </div>
                            <span class="adr-bar-label">Subgerencia de Medio Ambiente, Ecolog√≠a, Saneamiento y
                                Salubridad</span>
                        </div>
                    </div>
                </div>
            </section>
            <section class="adr-bottom-section">
                <div class="adr-pie-card">
                    <h3 class="adr-pie-title">
                        <i class="fas fa-chart-pie"></i>
                        Distribuci√≥n por Categor√≠a
                    </h3>
                    <div class="adr-pie-container">
                        <svg class="adr-pie-chart" viewBox="0 0 200 200">
                            <!-- Bienes 40% -->
                            <circle class="adr-pie-segment adr-pie-bienes" cx="100" cy="100" r="80"
                                stroke-dasharray="201 502" stroke-dashoffset="0"></circle>
                            <!-- Servicios 32% -->
                            <circle class="adr-pie-segment adr-pie-servicios" cx="100" cy="100" r="80"
                                stroke-dasharray="161 502" stroke-dashoffset="-201"></circle>
                            <!-- Obras 28% -->
                            <circle class="adr-pie-segment adr-pie-obras" cx="100" cy="100" r="80"
                                stroke-dasharray="141 502" stroke-dashoffset="-362"></circle>
                        </svg>
                        <div class="adr-pie-legend">
                            <div class="adr-legend-item">
                                <span class="adr-legend-color adr-legend-bienes"></span>
                                <span class="adr-legend-label">Bienes <strong>40%</strong></span>
                            </div>
                            <div class="adr-legend-item">
                                <span class="adr-legend-color adr-legend-servicios"></span>
                                <span class="adr-legend-label">Servicios <strong>32%</strong></span>
                            </div>
                            <div class="adr-legend-item">
                                <span class="adr-legend-color adr-legend-obras"></span>
                                <span class="adr-legend-label">Obras <strong>28%</strong></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="adr-table-card">
                    <h3 class="adr-table-title">
                        <i class="fas fa-list"></i>
                        √öLTIMOS 5 REQUERIMIENTOS CREADOS
                    </h3>
                    <div class="adr-table-wrapper">
                        <table class="adr-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>√Årea</th>
                                    <th>Tipo</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td data-label="Fecha">05/11/2025</td>
                                    <td data-label="√Årea">Catastro</td>
                                    <td data-label="Tipo">Bienes</td>
                                    <td data-label="Estado"><span class="adr-badge adr-badge-pending">Pendiente</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td data-label="Fecha">04/11/2025</td>
                                    <td data-label="√Årea">Maquinaria</td>
                                    <td data-label="Tipo">Servicios</td>
                                    <td data-label="Estado"><span class="adr-badge adr-badge-process">En Proceso</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td data-label="Fecha">03/11/2025</td>
                                    <td data-label="√Årea">Obras</td>
                                    <td data-label="Tipo">Obras</td>
                                    <td data-label="Estado"><span
                                            class="adr-badge adr-badge-completed">Finalizado</span></td>
                                </tr>
                                <tr>
                                    <td data-label="Fecha">02/11/2025</td>
                                    <td data-label="√Årea">Medio Ambiente</td>
                                    <td data-label="Tipo">Bienes</td>
                                    <td data-label="Estado"><span class="adr-badge adr-badge-process">En Proceso</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td data-label="Fecha">01/11/2025</td>
                                    <td data-label="√Årea">Catastro</td>
                                    <td data-label="Tipo">Servicios</td>
                                    <td data-label="Estado"><span
                                            class="adr-badge adr-badge-completed">Finalizado</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

        </div>
    </main>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import {
            getFirestore, collection, onSnapshot
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        // Configuraci√≥n corregida
        const firebaseConfig = {
            apiKey: "AIzaSyD-V6hfGyOETDNxJf8Stb9DujbxQTIM76c",
            authDomain: "web-requerimientos.firebaseapp.com",
            projectId: "web-requerimientos",
            storageBucket: "web-requerimientos.appspot.com",
            messagingSenderId: "707688130249",
            appId: "1:707688130249:web:c46b6252c46083b6e9cf18",
            measurementId: "G-TV2C27SXD3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // üîí Verifica sesi√≥n activa
        onAuthStateChanged(auth, user => {
            if (user) {
                document.querySelector('.adr-subtitle').textContent = `Hola, ${user.email}`;
                cargarDatosTiempoReal();
            } else {
                window.location.href = "/log/login.html";
            }
        });
        document.body.classList.add("loaded");
        // Limpia los datos de ejemplo antes de cargar los reales
        document.querySelector(".adr-summary-number").textContent = "‚Äî";
        document.querySelectorAll(".adr-status-value").forEach(e => e.textContent = "‚Äî");
        document.querySelector(".adr-bar-chart").innerHTML = "<p style='text-align:center;color:#777;'>Cargando datos...</p>";
        document.querySelector(".adr-table tbody").innerHTML = "<tr><td colspan='4' style='text-align:center;'>Cargando...</td></tr>";

        // üì° Funci√≥n para escuchar cambios en Firestore en tiempo real
        function cargarDatosTiempoReal() {
            const reqRef = collection(db, "requerimientos");
        onSnapshot(reqRef, (snapshot) => {
    let total = snapshot.size;
    let pendientes = 0;
    let proceso = 0;
    let finalizados = 0;

    let ultimos = [];
    let conteoAreas = {}; // Para gr√°fico de barras
    let conteoTipos = { Bienes: 0, Servicios: 0, Obras: 0 }; // Para gr√°fico de pastel

    snapshot.forEach(doc => {
    const data = doc.data();

    const estado = (data.estado || "").trim().toLowerCase();
    const tipo = (data.tipo || "").trim().toLowerCase();
    const area = (data.area || "Sin √°rea")
  .trim()
  .toLowerCase()
  .replace(/\b\w/g, l => l.toUpperCase()); 


    // üßÆ Contadores por estado
    if (estado.includes("pendiente")) pendientes++;
    else if (estado.includes("proceso")) proceso++;
    else if (estado.includes("finalizado")) finalizados++;

    // üìä Conteo por √°rea
    conteoAreas[area] = (conteoAreas[area] || 0) + 1;

    // ü•ß Conteo por tipo
if (tipo.includes("bien")) conteoTipos.Bienes++;
else if (tipo.includes("servicio")) conteoTipos.Servicios++;
else if (tipo.includes("obra")) conteoTipos.Obras++;


    ultimos.push(data);
});


    // === üßÆ Actualizar totales ===
    document.querySelector(".adr-summary-number").textContent = total;
    document.querySelector(".adr-status-item.adr-pending .adr-status-value").textContent = pendientes;
    document.querySelector(".adr-status-item.adr-process .adr-status-value").textContent = proceso;
    document.querySelector(".adr-status-item.adr-completed .adr-status-value").textContent = finalizados;

    // === üïê Tabla de √∫ltimos 5 requerimientos ===
    ultimos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
    const tbody = document.querySelector(".adr-table tbody");
    tbody.innerHTML = "";
    ultimos.slice(0, 5).forEach(r => {
        const fila = `
            <tr>
                <td data-label="Fecha">${r.fecha}</td>
                <td data-label="√Årea">${r.area}</td>
                <td data-label="Tipo">${r.tipo}</td>
                <td data-label="Estado">
                    <span class="adr-badge ${r.estado === "Pendiente"
                        ? "adr-badge-pending"
                        : r.estado === "En Proceso"
                        ? "adr-badge-process"
                        : "adr-badge-completed"}">${r.estado}</span>
                </td>
            </tr>`;
        tbody.innerHTML += fila;
    });

    // === üìä Gr√°fico de barras (por √°rea) ===
    const barContainer = document.querySelector(".adr-bar-chart");
    barContainer.innerHTML = "";

    const areasOrdenadas = Object.entries(conteoAreas).sort((a, b) => b[1] - a[1]);
    const max = Math.max(...areasOrdenadas.map(a => a[1]), 1);

    areasOrdenadas.forEach(([area, cantidad], i) => {
        const altura = (cantidad / max) * 100;
        barContainer.innerHTML += `
            <div class="adr-bar-item">
                <div class="adr-bar-wrapper">
                    <div class="adr-bar adr-bar-${i + 1}" style="height:${altura}%;" data-value="${cantidad}"></div>
                </div>
                <span class="adr-bar-label">${area}</span>
            </div>`;
    });

    // === ü•ß Gr√°fico de pastel (por tipo) ===
    const totalTipos = conteoTipos.Bienes + conteoTipos.Servicios + conteoTipos.Obras;
    const circBienes = document.querySelector(".adr-pie-bienes");
    const circServicios = document.querySelector(".adr-pie-servicios");
    const circObras = document.querySelector(".adr-pie-obras");
    const circ = 2 * Math.PI * 80;

    let offset = 0;

    const porcentajeBienes = totalTipos ? (conteoTipos.Bienes / totalTipos) * 100 : 0;
    const porcentajeServicios = totalTipos ? (conteoTipos.Servicios / totalTipos) * 100 : 0;
    const porcentajeObras = totalTipos ? (conteoTipos.Obras / totalTipos) * 100 : 0;

    circBienes.setAttribute("stroke-dasharray", `${(porcentajeBienes / 100) * circ} ${circ}`);
    circBienes.setAttribute("stroke-dashoffset", offset);
    offset -= (porcentajeBienes / 100) * circ;

    circServicios.setAttribute("stroke-dasharray", `${(porcentajeServicios / 100) * circ} ${circ}`);
    circServicios.setAttribute("stroke-dashoffset", offset);
    offset -= (porcentajeServicios / 100) * circ;

    circObras.setAttribute("stroke-dasharray", `${(porcentajeObras / 100) * circ} ${circ}`);
    circObras.setAttribute("stroke-dashoffset", offset);

    document.querySelector(".adr-legend-bienes").nextElementSibling.innerHTML =
        `Bienes <strong>${porcentajeBienes.toFixed(0)}%</strong>`;
    document.querySelector(".adr-legend-servicios").nextElementSibling.innerHTML =
        `Servicios <strong>${porcentajeServicios.toFixed(0)}%</strong>`;
    document.querySelector(".adr-legend-obras").nextElementSibling.innerHTML =
        `Obras <strong>${porcentajeObras.toFixed(0)}%</strong>`;
}, (err) => {
    console.error("‚ùå Error al leer datos:", err.message);
});

        }
    </script>
    <script type="module">
        // ‚ö†Ô∏è EJECUTAR ESTE SCRIPT UNA SOLA VEZ EN LA CONSOLA DEL NAVEGADOR
// Abre admin/admin.html, presiona F12, ve a Console y pega este c√≥digo

import { getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
import { collection } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

// Mapa de √°reas
const areaToIdMap = {
    "Subgerencia de Catastro, Planeamiento y Control Urbano": "catastro-planeamiento",
    "Subgerencia de Maquinarias": "maquinarias",
    "Subgerencia de Supervisi√≥n y Ejecuci√≥n de Obras": "supervision-obras",
    "Subgerencia de Medio Ambiente, Ecolog√≠a, Saneamiento y Salubridad": "medio-ambiente",
    "Subgerencia de Mercados y Cementerios": "mercados-cementerios",
    "Subgerencia de Transporte, Tr√°nsito y Circulaci√≥n Vial": "transporte-transito",
    "Subgerencia de Seguridad Ciudadana": "seguridad-ciudadana",
    "Subgerencia de Educaci√≥n, Cultura, Deportes y Recreaci√≥n": "educacion-cultura",
    "Subgerencia de Defensor√≠a Municipal del Ni√±o y Adolescente": "defensoria-nino",
    "Subgerencia Municipal Persona con Discapacidad": "discapacidad",
    "Subgerencia de Participaci√≥n Vecinal y Organizaciones Sociales": "participacion-vecinal",
    "Subgerencia de Desarrollo Tur√≠stico y Promoci√≥n Empresarial PYMES": "turismo-pymes",
    "Subgerencia de Proyectos Agropecuarios": "proyectos-agropecuarios",
    "Programa del Vaso de Leche": "vaso-de-leche",
    "Programa PAN-TBC": "pan-tbc",
    "Unidad de Agua y Alcantarillado": "agua-alcantarillado",
    "Agencias Municipales": "agencias-municipales",
    "Subgerencia de Abastecimiento": "abastecimiento",
    "Subgerencia de Contabilidad": "contabilidad",
    "Subgerencia de Tesorer√≠a": "tesoreria",
    "Subgerencia de Personal": "personal",
    "Subgerencia de Control Patrimonial": "control-patrimonial",
    "Subgerencia de Recaudaci√≥n y Control": "recaudacion-control",
    "Subgerencia de Fiscalizaci√≥n Tributaria": "fiscalizacion-tributaria",
    "Subgerencia de Ejecuci√≥n Coactiva": "ejecucion-coactiva",
    "Subgerencia de Comercializaci√≥n, Comercio Ambulatorio y Feria": "comercializacion",
    "Oficina de Asesor√≠a Jur√≠dica": "asesoria-juridica",
    "Oficina de Planeamiento, Presupuesto y Racionalizaci√≥n": "planeamiento-presupuesto",
    "Oficina de Tecnolog√≠a": "tecnologia",
    "Oficina de Secretar√≠a General": "secretaria-general",
    "Unidad Tr√°mite Documentario": "tramite-documentario",
    "Unidad de Archivo Central": "archivo-central",
    "Unidad de Orientaci√≥n a la Ciudadan√≠a": "orientacion-ciudadania"
};

async function migrarAreaIds() {
    console.log("üöÄ Iniciando migraci√≥n de areaId...");
    
    // Usa la referencia global de Firebase que ya existe en admin.html
    const reqRef = collection(window.db || db, "requerimientos");
    
    try {
        const snapshot = await getDocs(reqRef);
        let actualizados = 0;
        let errores = 0;
        
        for (const docu of snapshot.docs) {
            const data = docu.data();
            const nombreArea = data.area || "";
            
            // Buscar el areaId correspondiente
            const areaId = areaToIdMap[nombreArea];
            
            if (areaId) {
                try {
                    await updateDoc(doc(reqRef, docu.id), {
                        areaId: areaId
                    });
                    console.log(`‚úÖ ${docu.id}: ${nombreArea} ‚Üí ${areaId}`);
                    actualizados++;
                } catch (e) {
                    console.error(`‚ùå Error en ${docu.id}:`, e);
                    errores++;
                }
            } else {
                console.warn(`‚ö†Ô∏è Sin mapeo para: "${nombreArea}"`);
            }
        }
        
        console.log(`\n‚ú® Migraci√≥n completada:`);
        console.log(`   Actualizados: ${actualizados}`);
        console.log(`   Errores: ${errores}`);
        console.log(`   Total: ${snapshot.size}`);
        
    } catch (error) {
        console.error("‚ùå Error en migraci√≥n:", error);
    }
}

// EJECUTAR LA MIGRACI√ìN
migrarAreaIds();
    </script>
</body>


</html>
